<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Undo and Redo &#8212; simple_app_state 2026 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=fc6fd62b"></script>
    <script src="../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Persistence and Restore" href="persistence_and_restore.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="undo-and-redo">
<h1>Undo and Redo<a class="headerlink" href="#undo-and-redo" title="Link to this heading">¶</a></h1>
<p>This section explains how <strong>SimpleAppState</strong> supports undo and redo operations.</p>
<p>Undo / redo is implemented by integrating
the <strong>file_state_manager</strong> package with the internal state structure of
<strong>SimpleAppState</strong>.</p>
<hr class="docutils" />
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Undo and redo in <strong>SimpleAppState</strong> are based on snapshot history.</p>
<ul class="simple">
<li><p>Each finalized state change is stored as a cloned snapshot</p></li>
<li><p>Undo moves backward in the snapshot history</p></li>
<li><p>Redo moves forward in the snapshot history</p></li>
</ul>
<p>This mechanism relies on:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CloneableFile.clone()</span></code> for snapshot creation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FileStateManager</span></code> for history management</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">replaceDataFrom()</span></code> for applying restored state</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="state-snapshots">
<h2>State Snapshots<a class="headerlink" href="#state-snapshots" title="Link to this heading">¶</a></h2>
<p><strong>SimpleAppState</strong> implements the <code class="docutils literal notranslate"><span class="pre">CloneableFile</span></code> interface.</p>
<p>This allows the entire application state to be:</p>
<ul class="simple">
<li><p>Deep-copied using <code class="docutils literal notranslate"><span class="pre">clone()</span></code></p></li>
<li><p>Managed as an immutable snapshot by <code class="docutils literal notranslate"><span class="pre">FileStateManager</span></code></p></li>
</ul>
<p>Each snapshot represents a complete and self-contained application state
at a specific point in time.</p>
<p>Snapshots are used exclusively for undo / redo and are independent of
persistence mechanisms such as <code class="docutils literal notranslate"><span class="pre">toDict()</span></code> and <code class="docutils literal notranslate"><span class="pre">fromDict()</span></code>.</p>
</section>
<hr class="docutils" />
<section id="filestatemanager-integration">
<h2>FileStateManager Integration<a class="headerlink" href="#filestatemanager-integration" title="Link to this heading">¶</a></h2>
<p>To enable undo / redo support, register a <strong>SimpleAppState</strong> instance
with <code class="docutils literal notranslate"><span class="pre">FileStateManager</span></code>.</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleAppState</span><span class="p">();</span>
<span class="kd">final</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FileStateManager</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="nl">stackSize:</span><span class="w"> </span><span class="m">20</span><span class="p">);</span>
</pre></div>
</div>
<p>The manager stores cloned snapshots and tracks the current position
in the history stack.</p>
</section>
<hr class="docutils" />
<section id="state-listener-and-push-timing">
<h2>State Listener and Push Timing<a class="headerlink" href="#state-listener-and-push-timing" title="Link to this heading">¶</a></h2>
<p>Undo / redo history must be updated <strong>only when a state change is finalized</strong>.</p>
<p>For this purpose, <strong>SimpleAppState</strong> provides a dedicated state listener.</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="c1">/// Adds a listener suitable for undo / redo management.</span>
<span class="c1">/// This listener is notified only when a state change is finalized.</span>
<span class="c1">/// Batch updates trigger the notification only once.</span>
<span class="kt">void</span><span class="w"> </span><span class="n">setStateListener</span><span class="p">(</span><span class="n">StateListener</span><span class="o">?</span><span class="w"> </span><span class="n">listener</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">_stateListener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listener</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A typical integration looks like this:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="n">state</span><span class="p">.</span><span class="n">setStateListener</span><span class="p">((</span><span class="n">SimpleAppState</span><span class="w"> </span><span class="n">mState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fsm</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">mState</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>This design ensures that:</p>
<ul class="simple">
<li><p>Intermediate mutations are not recorded</p></li>
<li><p>Batch updates produce a single history entry</p></li>
<li><p>Each undo step corresponds to a meaningful user action</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="undo-operation">
<h2>Undo Operation<a class="headerlink" href="#undo-operation" title="Link to this heading">¶</a></h2>
<p>Calling <code class="docutils literal notranslate"><span class="pre">undo()</span></code> retrieves the previous snapshot from the history stack.</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsm</span><span class="p">.</span><span class="n">undo</span><span class="p">();</span>
</pre></div>
</div>
<p>If undo is possible, a cloned snapshot is returned.
The returned snapshot must then be applied to the current state.</p>
<section id="applying-a-snapshot-safely">
<h3>Applying a Snapshot Safely<a class="headerlink" href="#applying-a-snapshot-safely" title="Link to this heading">¶</a></h3>
<p>When restoring a snapshot using <code class="docutils literal notranslate"><span class="pre">replaceDataFrom()</span></code>,
the internal state of <strong>SimpleAppState</strong> is replaced.</p>
<p>This operation <strong>finalizes a state change</strong>, which would normally trigger
the state listener.</p>
<p>To prevent the restored snapshot from being recorded as a new history entry,
you must suppress the next push operation.</p>
<p><code class="docutils literal notranslate"><span class="pre">FileStateManager</span></code> provides <code class="docutils literal notranslate"><span class="pre">skipNextPush()</span></code> for this purpose.</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsm</span><span class="p">.</span><span class="n">undo</span><span class="p">();</span>
<span class="n">fsm</span><span class="p">.</span><span class="n">skipNextPush</span><span class="p">();</span>
<span class="n">state</span><span class="p">.</span><span class="n">replaceDataFrom</span><span class="p">(</span><span class="n">previous</span><span class="p">);</span>
</pre></div>
</div>
<p>Key characteristics of <code class="docutils literal notranslate"><span class="pre">replaceDataFrom()</span></code>:</p>
<ul class="simple">
<li><p>The current <code class="docutils literal notranslate"><span class="pre">SimpleAppState</span></code> instance remains active</p></li>
<li><p>Only internal data is replaced</p></li>
<li><p>No new history entry is created when <code class="docutils literal notranslate"><span class="pre">skipNextPush()</span></code> is used</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="redo-operation">
<h2>Redo Operation<a class="headerlink" href="#redo-operation" title="Link to this heading">¶</a></h2>
<p>Redo retrieves the next snapshot in the history stack.</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsm</span><span class="p">.</span><span class="n">redo</span><span class="p">();</span>
<span class="n">fsm</span><span class="p">.</span><span class="n">skipNextPush</span><span class="p">();</span>
<span class="n">state</span><span class="p">.</span><span class="n">replaceDataFrom</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</pre></div>
</div>
<p>Redo follows the same rules as undo and must also suppress
automatic history pushes during restoration.</p>
</section>
<hr class="docutils" />
<section id="complete-example">
<h2>Complete Example<a class="headerlink" href="#complete-example" title="Link to this heading">¶</a></h2>
<p>The following test demonstrates a complete undo / redo flow:</p>
<div class="highlight-dart notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">(</span><span class="s1">&#39;undo and redo&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleAppState</span><span class="p">();</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">intSlot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">slot</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="w"> </span><span class="nl">initial:</span><span class="w"> </span><span class="m">1</span><span class="p">);</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">fsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FileStateManager</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="nl">stackSize:</span><span class="w"> </span><span class="m">20</span><span class="p">);</span>

<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">setStateListener</span><span class="p">((</span><span class="n">SimpleAppState</span><span class="w"> </span><span class="n">mState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fsm</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">mState</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="n">intSlot</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
<span class="w">  </span><span class="n">intSlot</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// undo</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsm</span><span class="p">.</span><span class="n">undo</span><span class="p">();</span>
<span class="w">  </span><span class="n">fsm</span><span class="p">.</span><span class="n">skipNextPush</span><span class="p">();</span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">replaceDataFrom</span><span class="p">(</span><span class="n">prev</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">SimpleAppState</span><span class="p">);</span>
<span class="w">  </span><span class="n">expect</span><span class="p">(</span><span class="n">intSlot</span><span class="p">.</span><span class="kd">get</span><span class="p">(),</span><span class="w"> </span><span class="m">2</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// redo</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsm</span><span class="p">.</span><span class="n">redo</span><span class="p">();</span>
<span class="w">  </span><span class="n">fsm</span><span class="p">.</span><span class="n">skipNextPush</span><span class="p">();</span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">replaceDataFrom</span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">SimpleAppState</span><span class="p">);</span>
<span class="w">  </span><span class="n">expect</span><span class="p">(</span><span class="n">intSlot</span><span class="p">.</span><span class="kd">get</span><span class="p">(),</span><span class="w"> </span><span class="m">3</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="design-rationale">
<h2>Design Rationale<a class="headerlink" href="#design-rationale" title="Link to this heading">¶</a></h2>
<p>This design provides several important guarantees:</p>
<ul class="simple">
<li><p>Undo history reflects logical state changes, not low-level mutations</p></li>
<li><p>Restored states do not pollute the history stack</p></li>
<li><p>Undo / redo logic remains decoupled from state mutation logic</p></li>
<li><p>Slot references remain valid across undo / redo operations</p></li>
</ul>
<p>By explicitly controlling push timing,
<strong>SimpleAppState</strong> ensures predictable and intuitive undo / redo behavior.</p>
</section>
<hr class="docutils" />
<section id="design-separation">
<h2>Design Separation<a class="headerlink" href="#design-separation" title="Link to this heading">¶</a></h2>
<p>Undo / redo is intentionally separated from persistence.</p>
<ul class="simple">
<li><p>Persistence uses <code class="docutils literal notranslate"><span class="pre">toDict()</span></code> and <code class="docutils literal notranslate"><span class="pre">fromDict()</span></code></p></li>
<li><p>Undo / redo uses <code class="docutils literal notranslate"><span class="pre">clone()</span></code> and snapshot replacement</p></li>
</ul>
<p>Keeping these mechanisms independent maintains clarity and avoids
unexpected interactions between state restoration and persistence.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">simple_app_state</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core_concepts/index.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flutter_integration/index.html">Flutter Integration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced Topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="persistence_and_restore.html">Persistence and Restore</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Undo and Redo</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../project_management_and_design/index.html">Project Management and Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notice.html">Notice</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Advanced Topics</a><ul>
      <li>Previous: <a href="persistence_and_restore.html" title="previous chapter">Persistence and Restore</a></li>
      <li>Next: <a href="testing.html" title="next chapter">Testing</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2026, Masahide Mori.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/advanced/undo_redo.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>